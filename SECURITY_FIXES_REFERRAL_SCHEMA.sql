-- Security Fix: Add Proper Schema Definitions for Referral Tables
-- This migration adds the referral tables that are currently accessed via raw SQL
-- Once applied, update the TypeScript schema and refactor the referral routers

-- 1. Referral Codes Table
CREATE TABLE IF NOT EXISTS referral_codes (
  id INT AUTO_INCREMENT PRIMARY KEY,
  userId INT NOT NULL,
  code VARCHAR(20) NOT NULL UNIQUE,
  rewardType VARCHAR(50) DEFAULT 'pro_days',
  rewardAmount INT DEFAULT 7,
  maxUses INT DEFAULT NULL,
  usesCount INT NOT NULL DEFAULT 0,
  expiresAt TIMESTAMP NULL DEFAULT NULL,
  isActive TINYINT NOT NULL DEFAULT 1,
  createdAt TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_referral_code (code),
  INDEX idx_referral_user (userId),
  INDEX idx_referral_active (isActive),
  FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2. Referral Redemptions Table
CREATE TABLE IF NOT EXISTS referral_redemptions (
  id INT AUTO_INCREMENT PRIMARY KEY,
  referralCodeId INT NOT NULL,
  referredUserId INT NOT NULL,
  referrerUserId INT NOT NULL,
  referrerReward JSON DEFAULT NULL,
  refereeReward JSON DEFAULT NULL,
  redeemedAt TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  convertedToPaid TINYINT NOT NULL DEFAULT 0,
  conversionDate TIMESTAMP NULL DEFAULT NULL,
  INDEX idx_referred_user (referredUserId),
  INDEX idx_referrer_user (referrerUserId),
  INDEX idx_referral_code (referralCodeId),
  INDEX idx_converted (convertedToPaid),
  FOREIGN KEY (referralCodeId) REFERENCES referral_codes(id) ON DELETE CASCADE,
  FOREIGN KEY (referredUserId) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (referrerUserId) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY unique_referral_per_user (referredUserId)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 3. User Referral Stats Table
CREATE TABLE IF NOT EXISTS user_referral_stats (
  id INT AUTO_INCREMENT PRIMARY KEY,
  userId INT NOT NULL UNIQUE,
  totalReferrals INT NOT NULL DEFAULT 0,
  successfulReferrals INT NOT NULL DEFAULT 0,
  pendingReferrals INT NOT NULL DEFAULT 0,
  proDaysEarned INT NOT NULL DEFAULT 0,
  creditsEarned INT NOT NULL DEFAULT 0,
  currentTier VARCHAR(20) NOT NULL DEFAULT 'bronze',
  rank INT DEFAULT NULL,
  lastReferralAt TIMESTAMP NULL DEFAULT NULL,
  updatedAt TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_stats_user (userId),
  INDEX idx_stats_tier (currentTier),
  INDEX idx_stats_rank (rank),
  INDEX idx_successful_referrals (successfulReferrals),
  FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 4. Viral Events Table (for tracking sharing behavior)
CREATE TABLE IF NOT EXISTS viral_events (
  id INT AUTO_INCREMENT PRIMARY KEY,
  userId INT NOT NULL,
  eventType VARCHAR(100) NOT NULL,
  metadata JSON DEFAULT NULL,
  createdAt TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_viral_user (userId),
  INDEX idx_viral_event (eventType),
  INDEX idx_viral_created (createdAt),
  FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Add comments for documentation
ALTER TABLE referral_codes COMMENT = 'Stores unique referral codes generated by users';
ALTER TABLE referral_redemptions COMMENT = 'Tracks when new users redeem referral codes';
ALTER TABLE user_referral_stats COMMENT = 'Aggregate statistics for referral program participants';
ALTER TABLE viral_events COMMENT = 'Tracks viral sharing events for growth analytics';
